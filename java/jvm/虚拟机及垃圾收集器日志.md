# 虚拟机及垃圾收集器日志

阅读分析虚拟机和垃圾收集器的日志是处理Java虚拟机内存问题必备的基础技能，垃圾收集器日志是一系列人为设定的规则，多少有点随开发者编码时的心情而定，没有任何的“业界标准”可言，换句话说，每个收集器的日志格式都可能不一样。除此以外还有一个麻烦，在JDK 9以前，HotSpot并没有提供统一的日志处理框架，虚拟机各个功能模块的日志开关分布在不同的参数上，日志级别、循环日志大小、输出格式、重定向等设置在不同功能上都要单独解决。直到JDK 9，这种混乱不堪的局面才终于消失，HotSpot所有功能的日志都收归到了“-Xlog”参数上，这个参数的能力也相应被极大拓展了：

```
-Xlog[:[selector][:[output][:[decorators][:output-options]]]]
```

命令行中最关键的参数是选择器（Selector），它由标签（Tag）和日志级别（Level）共同组成。标签可理解为虚拟机中某个功能模块的名字，它告诉日志框架用户希望得到虚拟机哪些功能的日志输出。垃圾收集器的标签名称为“gc”，由此可见，垃圾收集器日志只是HotSpot众多功能日志的其中一项，全部支持的功能模块标签名如下所示：

```
add, age, alloc, annotation, aot, arguments, attach, barrier, biasedlocking, blocks, bot, breakpoint, bytecode, census, class, classhisto, cleanup, compaction, comparator, constraints, constantpool, coops, cpu, cset, data, defaultmethods, dump, ergo, event, exceptions, exit, fingerprint, freelist, gc, hashtables, heap, humongous, ihop, iklass, init, itables, jfr, jni, jvmti, liveness, load, loader, logging, mark, marking, metadata, metaspace, method, mmu, modules, monitorinflation, monitormismatch, nmethod, normalize, objecttagging, obsolete, oopmap, os, pagesize, parser, patch, path, phases, plab, preorder, promotion, protectiondomain, purge, redefine, ref, refine, region, remset, resolve, safepoint, scavenge, scrub, setting, stackmap, stacktrace, stackwalk, start, startuptime, state, stats, stringdedup, stringtable, subclass, survivor, sweep, system, task, thread, time, timer, tlab, unload, update, verification, verify, vmoperation, vtables, workgang
```

日志级别从低到高，共有Trace，Debug，Info，Warning，Error，Off六种级别，日志级别决定了输出信息的详细程度，默认级别为Info，HotSpot的日志规则与Log4j、SLF4j这类Java日志框架大体上是一致的。另外，还可以使用修饰器（Decorator）来要求每行日志输出都附加上额外的内容，支持附加在日志行上的信息包括：
·time：当前日期和时间。
·uptime：虚拟机启动到现在经过的时间，以秒为单位。
·timemillis：当前时间的毫秒数，相当于System.currentTimeMillis()的输出。
·uptimemillis：虚拟机启动到现在经过的毫秒数。
·timenanos：当前时间的纳秒数，相当于System.nanoTime()的输出。
·uptimenanos：虚拟机启动到现在经过的纳秒数。
·pid：进程ID。
·tid：线程ID。
·level：日志级别。
·tags：日志输出的标签集。
如果不指定，默认值是uptime、level、tags这三个，此时日志输出类似于以下形式

```
[3.080s][info][gc,cpu] GC(5) User=0.03s Sys=0.00s Real=0.01s
```

下图为全部在JDK 9中被废弃的日志相关参数及它们在JDK 9后使用-Xlog的代替配置形式。

![JDK9日志参数变化](https://raw.githubusercontent.com/renjiema/images/main/blogs/20210519141749.png)

下面举几个例子，展示在JDK 9统一日志框架前、后是如何获得垃圾收集器过程的相关信息，以下均以JDK 11的G1收集器（JDK 9下默认收集器就是G1，所以命令行中没有指定收集器）为例。

测试代码如下：

```java
public class GCTest {
    private static final Random RANDOM = new Random();
    private static final List<Object> objs = new ArrayList<>();

    public static void produceGarbage() {
        for (int i = 0; i < 1000000; i++) {
            new Object();
            if ((RANDOM.nextInt() + 1) % 100 == 0) {
                objs.add(new Object());
            }
        }
    }

    public static void main(String[] args) {
        while (true) {
            produceGarbage();
        }
    }
}
```

1. 查看GC基本信息，在JDK 9之前使用-XX:+PrintGC，JDK 9后使用-Xlog:gc：

```bash
$ java -Xlog:gc GCTest.java
[0.006s][info][gc] Using G1
[0.456s][info][gc] GC(0) Pause Young (Normal) (G1 Evacuation Pause) 24M->2M(500M) 7.473ms
[1.066s][info][gc] GC(1) Pause Young (Normal) (G1 Evacuation Pause) 32M->22M(500M) 14.451ms
[2.277s][info][gc] GC(2) Pause Young (Normal) (G1 Evacuation Pause) 68M->69M(500M) 30.491ms
[3.472s][info][gc] GC(3) Pause Young (Normal) (G1 Evacuation Pause) 105M->107M(500M) 19.614ms
[5.275s][info][gc] GC(4) Pause Young (Normal) (G1 Evacuation Pause) 161M->163M(676M) 30.018ms
[7.317s][info][gc] GC(5) Pause Young (Normal) (G1 Evacuation Pause) 233M->235M(676M) 29.550ms
[9.599s][info][gc] GC(6) Pause Young (Normal) (G1 Evacuation Pause) 327M->331M(676M) 32.882ms
[13.064s][info][gc] GC(7) Pause Young (Concurrent Start) (G1 Humongous Allocation) 391M->395M(676M) 37.852ms
[13.064s][info][gc] GC(8) Concurrent Cycle
[13.236s][info][gc] GC(8) Pause Remark 477M->365M(676M) 1.525ms
[13.388s][info][gc] GC(8) Pause Cleanup 368M->368M(676M) 0.192ms
[13.389s][info][gc] GC(8) Concurrent Cycle 324.538ms
[16.936s][info][gc] GC(9) Pause Young (Normal) (G1 Evacuation Pause) 429M->433M(816M) 41.896ms
```

2. 查看GC详细信息，在JDK 9之前使用-XX：+PrintGCDetails，在JDK 9之后使用-X-log：gc*，用通配符*将GC标签下所有细分过程都打印出来，如果把日志级别调整到Debug或者Trace，还将获得更多细节信息：

```bash
$ java -Xlog:gc* GCTest.java
[0.003s][info][gc,heap] Heap region size: 2M
[0.006s][info][gc     ] Using G1
[0.006s][info][gc,heap,coops] Heap address: 0x000000060c000000, size: 8000 MB, Compressed Oops mode: Zero based, Oop shift amount: 3
[0.446s][info][gc,start     ] GC(0) Pause Young (Normal) (G1 Evacuation Pause)
[0.447s][info][gc,task      ] GC(0) Using 10 workers of 10 for evacuation
[0.452s][info][gc,phases    ] GC(0)   Pre Evacuate Collection Set: 0.0ms
[0.452s][info][gc,phases    ] GC(0)   Evacuate Collection Set: 4.3ms
[0.452s][info][gc,phases    ] GC(0)   Post Evacuate Collection Set: 0.5ms
[0.452s][info][gc,phases    ] GC(0)   Other: 1.7ms
[0.452s][info][gc,heap      ] GC(0) Eden regions: 12->0(148)
[0.452s][info][gc,heap      ] GC(0) Survivor regions: 0->2(2)
[0.452s][info][gc,heap      ] GC(0) Old regions: 0->0
[0.452s][info][gc,heap      ] GC(0) Humongous regions: 0->0
[0.452s][info][gc,metaspace ] GC(0) Metaspace: 14933K->14933K(1062912K)
[0.452s][info][gc           ] GC(0) Pause Young (Normal) (G1 Evacuation Pause) 24M->2M(500M) 6.635ms
[0.452s][info][gc,cpu       ] GC(0) User=0.04s Sys=0.00s Real=0.01s
[0.993s][info][gc,start     ] GC(1) Pause Young (Normal) (G1 Evacuation Pause)
[0.993s][info][gc,task      ] GC(1) Using 10 workers of 10 for evacuation
[1.007s][info][gc,phases    ] GC(1)   Pre Evacuate Collection Set: 0.0ms
[1.007s][info][gc,phases    ] GC(1)   Evacuate Collection Set: 13.5ms
[1.007s][info][gc,phases    ] GC(1)   Post Evacuate Collection Set: 0.5ms
[1.007s][info][gc,phases    ] GC(1)   Other: 0.1ms
[1.007s][info][gc,heap      ] GC(1) Eden regions: 11->0(37)
[1.007s][info][gc,heap      ] GC(1) Survivor regions: 2->2(2)
[1.007s][info][gc,heap      ] GC(1) Old regions: 0->4
[1.007s][info][gc,heap      ] GC(1) Humongous regions: 5->5
[1.007s][info][gc,metaspace ] GC(1) Metaspace: 14934K->14934K(1062912K)
[1.007s][info][gc           ] GC(1) Pause Young (Normal) (G1 Evacuation Pause) 34M->21M(500M) 14.466ms
[1.008s][info][gc,cpu       ] GC(1) User=0.13s Sys=0.00s Real=0.01s
```



> 注：本文为《深入理解Java虚拟机：JVM高级特性与最佳实战》读书笔记